import telebot
import random
import time
import json
from datetime import datetime, timedelta
import locale
import os

# Русская локаль для даты
locale.setlocale(locale.LC_TIME, "ru_RU.UTF-8")

TOKEN = "YOUR_BOT_TOKEN"  # Вставь свой токен
CHANNEL_ID = "@your_channel"  # Юзернейм канала
bot = telebot.TeleBot(TOKEN)

# === Шаблоны прогнозов ===
start_phrases = [
    "Сегодняшние события могут подсказать,", "В этот день проявится тенденция, что",
    "Энергии суток дают сигнал о том,", "Наступающий день принесёт ощущение, что",
    "Окружающий мир будет намекать,", "Судьба мягко напомнит тебе, что",
    "С самого утра станет ясно,", "День начнётся с осознания, что",
    "Течение обстоятельств приведёт к мысли,", "Внутренний настрой подскажет, что",
    "В атмосфере дня ощущается знак, что", "Случайные встречи дадут понять, что",
    "Важные события раскроют идею,", "Поток энергии направит внимание на то, что",
    "Настроение укажет направление,", "Сама Вселенная укажет, что",
    "Сегодня проявится ощущение,", "Уже утром станет заметно, что",
    "Ход дня заставит осознать,", "Обстоятельства подтолкнут к выводу, что",
    "Скрытые процессы откроют мысль,", "Внутренний голос мягко подскажет, что",
    "Неожиданная подсказка судьбы даст знать,", "Обстоятельства укажут на то, что",
    "День покажет скрытые намёки о том,"
]

middle_phrases = [
    "важно прислушаться к внутреннему голосу,", "стоит сделать акцент на личных целях,", 
    "нужно уделить внимание деталям,", "полезно будет отпустить контроль,", 
    "лучше довериться процессу,", "хорошо бы направить усилия в творчество,",
    "необходимо проявить выдержку,", "следует уделить внимание окружению,", 
    "лучше сосредоточиться на личных задачах,", "важно избегать поспешных решений,", 
    "можно позволить себе немного отдыха,", "правильно будет учиться гибкости,", 
    "стоит проявить терпение,", "полезно обратить внимание на здоровье,", 
    "лучше действовать через сотрудничество,", "важно открыться новым знаниям,", 
    "нужно направить энергию в практичные дела,", "правильно будет быть внимательным к словам,", 
    "стоит довериться интуиции,", "полезно пересмотреть старые привычки,", 
    "лучше сделать акцент на честности,", "важно сохранять внутренний баланс,", 
    "следует довериться неожиданностям,", "правильно будет действовать спокойно,", 
    "лучше уделить внимание семье и дому,"
]

end_phrases = [
    "и это приведёт к неожиданному результату.", "что раскроет новые перспективы.",
    "позволив достичь внутреннего равновесия.", "и подарит неожиданные открытия.",
    "ведя тебя к гармонии и успеху.", "откроет путь к новому этапу жизни.",
    "и это принесёт чувство удовлетворения.", "ведя к долгожданной ясности.",
    "и результат удивит тебя.", "даря вдохновение и силы.",
    "ведя к внутренней свободе.", "и это укрепит уверенность в себе.",
    "позволив увидеть скрытые возможности.", "и это откроет двери к переменам.",
    "ведя к глубоким внутренним открытиям.", "и подарит гармонию в отношениях.",
    "откроет новые горизонты.", "и это принесёт умиротворение.",
    "ведя к осознанию скрытой истины.", "и это станет началом важного пути.",
    "откроет внутренний источник силы.", "и это приведёт к долгожданному прогрессу.",
    "подарит неожиданный поворот в событиях.", "и результат окажется полезнее, чем кажется.",
    "ведя к внутреннему обновлению."
]

# === Карты Таро (78) ===
tarot_cards = [
    "Шут — новые начинания, свобода", "Маг — сила воли, мастерство", "Верховная Жрица — интуиция, тайны",
    "Императрица — изобилие, забота", "Император — порядок, власть", "Иерофант — традиции, обучение",
    "Влюблённые — выбор, гармония", "Колесница — движение, победа", "Сила — внутренняя стойкость, мужество",
    "Отшельник — поиск истины, уединение", "Колесо Фортуны — перемены, судьба", "Справедливость — баланс, честность",
    "Повешенный — переоценка, новые взгляды", "Смерть — трансформация, конец и начало", "Умеренность — гармония, терпение",
    "Дьявол — искушения, зависимости", "Башня — разрушение, освобождение", "Звезда — надежда, вдохновение",
    "Луна — иллюзии, сны", "Солнце — радость, успех", "Суд — пробуждение, возрождение", "Мир — завершение, целостность",
    "Туз Жезлов — энергия, возможности", "Двойка Жезлов — планирование, выбор", "Тройка Жезлов — ожидания, перспективы",
    "Четвёрка Жезлов — праздник, стабильность", "Пятёрка Жезлов — конкуренция, вызов", "Шестёрка Жезлов — победа, признание",
    "Семёрка Жезлов — защита, упорство", "Восьмёрка Жезлов — скорость, новости", "Девятка Жезлов — стойкость, напряжение",
    "Десятка Жезлов — тяжесть, ответственность", "Паж Жезлов — энтузиазм, начало", "Рыцарь Жезлов — решимость, движение",
    "Королева Жезлов — уверенность, вдохновение", "Король Жезлов — лидерство, сила",
    "Туз Кубков — эмоции, любовь", "Двойка Кубков — союз, партнерство", "Тройка Кубков — радость, друзья",
    "Четвёрка Кубков — скука, недовольство", "Пятёрка Кубков — разочарование, потеря", "Шестёрка Кубков — воспоминания, прошлое",
    "Семёрка Кубков — иллюзии, выбор", "Восьмёрка Кубков — уход, поиск смысла", "Девятка Кубков — удовольствие, исполнение",
    "Десятка Кубков — гармония, семья", "Паж Кубков — вдохновение, чувства", "Рыцарь Кубков — романтика, мечты",
    "Королева Кубков — сострадание, чувствительность", "Король Кубков — зрелость, баланс",
    "Туз Мечей — истина, ясность", "Двойка Мечей — выбор, сомнения", "Тройка Мечей — боль, разрыв",
    "Четвёрка Мечей — отдых, восстановление", "Пятёрка Мечей — конфликт, поражение", "Шестёрка Мечей — движение вперёд",
    "Семёрка Мечей — хитрость, осторожность", "Восьмёрка Мечей — ограничения, страх", "Девятка Мечей — тревога, кошмары",
    "Десятка Мечей — конец, поражение", "Паж Мечей — любопытство, идеи", "Рыцарь Мечей — напор, импульс",
    "Королева Мечей — мудрость, независимость", "Король Мечей — рассудительность, логика",
    "Туз Пентаклей — возможности, материальные блага", "Двойка Пентаклей — баланс, адаптация", "Тройка Пентаклей — сотрудничество",
    "Четвёрка Пентаклей — удержание, контроль", "Пятёрка Пентаклей — трудности, лишения", "Шестёрка Пентаклей — помощь, щедрость",
    "Семёрка Пентаклей — терпение, ожидание", "Восьмёрка Пентаклей — работа, мастерство", "Девятка Пентаклей — успех, самодостаточность",
    "Десятка Пентаклей — богатство, семья", "Паж Пентаклей — учеба, практичность", "Рыцарь Пентаклей — надёжность, трудолюбие",
    "Королева Пентаклей — забота, уют", "Король Пентаклей — стабильность, достаток"
]

signs = [
    "♈️ Овен", "♉️ Телец", "♊️ Близнецы", "♋️ Рак",
    "♌️ Лев", "♍️ Дева", "♎️ Весы", "♏️ Скорпион",
    "♐️ Стрелец", "♑️ Козерог", "♒️ Водолей", "♓️ Рыбы"
]

compatibility = {
    "Овен": "Лев, Стрелец",
    "Телец": "Дева, Козерог",
    "Близнецы": "Весы, Водолей",
    "Рак": "Скорпион, Рыбы",
    "Лев": "Овен, Стрелец",
    "Дева": "Телец, Козерог",
    "Весы": "Близнецы, Водолей",
    "Скорпион": "Рак, Рыбы",
    "Стрелец": "Овен, Лев",
    "Козерог": "Телец, Дева",
    "Водолей": "Близнецы, Весы",
    "Рыбы": "Рак, Скорпион"
}

focus_options = [
    "Эмоциональная глубина", "Финансовая стабильность", "Творческое самовыражение",
    "Общение и связи", "Семейное благополучие", "Личностный рост",
    "Духовный поиск", "Физическая активность", "Профессиональный успех",
    "Внутренний баланс", "Отношения и дружба", "Смелые решения"
]

# === Файл для хранения использованных комбинаций ===
HISTORY_FILE = "used_combinations.json"
HISTORY_DAYS = 30  # Храним 30 дней

def load_history():
    if os.path.exists(HISTORY_FILE):
        with open(HISTORY_FILE, "r", encoding="utf-8") as f:
            data = json.load(f)
            cutoff = datetime.now() - timedelta(days=HISTORY_DAYS)
            return set(tuple(item["combo"]) for item in data if datetime.fromisoformat(item["date"]) > cutoff)
    return set()

def save_history(history):
    data = [{"combo": list(combo), "date": datetime.now().isoformat()} for combo in history]
    with open(HISTORY_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

used_combinations = load_history()

def generate_prediction():
    return f"{random.choice(start_phrases)} {random.choice(middle_phrases)} {random.choice(end_phrases)}"

def generate_post(sign):
    while True:
        prediction = generate_prediction()
        card = random.choice(tarot_cards)
        focus = random.choice(focus_options)
        combo = (prediction, card, focus)
        if combo not in used_combinations:
            used_combinations.add(combo)
            save_history(used_combinations)
            break

    sign_name = sign.split(" ")[1]
    today = datetime.now().strftime("%-d %B")

    text = f"""{sign}, {today}

💡 Прогноз: {prediction}

🎴 Карта дня: {card}

🎯 Фокус дня: {focus}
💞 Совместимость: {compatibility[sign_name]}

🔮 <a href="https://t.me/+QIQFGYWwkLhiYjFi">Научный гороскоп</a>"""
    return text

def main():
    for sign in signs:
        post = generate_post(sign)
        bot.send_message(CHANNEL_ID, post, parse_mode="HTML", disable_web_page_preview=True)
        time.sleep(180)  # 3 минуты между постами

if __name__ == "__main__":
    main()
